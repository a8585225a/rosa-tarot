<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rosa 抽牌（本地解牌＋快速複製）</title>
<style>
  :root{--bg:#fbfbfc;--fg:#111827;--muted:#6b7280;--line:#e5e7eb;--card:#fff}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,system-ui,'Noto Sans TC',Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-bottom:14px}
  .panel h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--line);font-size:18px}
  .panel .content{padding:16px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input{padding:10px;border:1px solid var(--line);border-radius:10px}
  button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#111827;color:#fff;cursor:pointer;font-weight:600}
  .muted{color:var(--muted);font-size:12px}
  .deck{display:flex;flex-direction:column;gap:28px}
  .deck-row{position:relative;width:100%;height:140px}
  .cardback{position:absolute;top:0;width:74px;height:120px;border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#0b4aa0;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease}
  .cardback img{width:100%;height:100%;object-fit:cover;pointer-events:none}
  .cardback:hover{transform:translateY(-4px);box-shadow:0 6px 12px rgba(0,0,0,.18)}
  .cardback.is-picked{opacity:.3;pointer-events:none;filter:saturate(.2)}
  .slots{display:flex;gap:16px;justify-content:center;flex-wrap:wrap}
  .slot,.picked{width:120px;height:190px;border-radius:14px;position:relative;flex:0 0 auto}
  .slot{border:2px dashed #ef4444;color:#ef4444;display:flex;align-items:center;justify-content:center;background:#fff}
  .picked{border:1px solid var(--line);background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.06);overflow:hidden;cursor:pointer}
  .picked img{width:100%;height:100%;object-fit:contain;background:#fff}
  .badge{position:absolute;top:8px;right:8px;background:#FEF3C7;color:#92400E;border:1px solid #FDE68A;padding:2px 8px;border-radius:999px;font-size:11px}
  .label{position:absolute;left:0;right:0;bottom:0;background:rgba(255,255,255,.94);padding:4px 6px;font-size:11px}
  pre{white-space:pre-wrap;font-size:14px;line-height:1.65;margin:0}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel"><h2>操作</h2><div class="content">
    <div class="toolbar">
      <input id="q" placeholder="輸入問題（例：我今天運勢如何？）" style="flex:1;min-width:220px">
      <button id="shuffle">重新洗牌</button>
      <button id="btnLocal">本地解牌</button>
      <button id="clear">清空選牌</button>
    </div>
    <div class="muted" style="margin-top:6px">兩列卡背自動交疊填滿整行。點卡背依序放入 4 個位置（第 4 張為建議）。</div>
  </div></div>

  <div class="panel"><h2>牌組</h2><div class="content">
    <div id="deck" class="deck">
      <div class="deck-row" id="row1"></div>
      <div class="deck-row" id="row2"></div>
    </div>
  </div></div>

  <div class="panel"><h2>你的選牌</h2><div class="content">
    <div class="slots" id="slots">
      <div class="slot" data-idx="0">牌 1</div>
      <div class="slot" data-idx="1">牌 2</div>
      <div class="slot" data-idx="2">牌 3</div>
      <div class="slot" data-idx="3">建議</div>
    </div>
  </div></div>

  <div class="panel"><h2>解讀</h2><div class="content">
    <pre id="out" class="muted">（尚未解讀）</pre>
  </div></div>

  <div class="panel"><h2>快速複製到 ChatGPT</h2><div class="content">
    <div class="muted" style="margin-bottom:6px">抽完牌後按「產生文字」→ 一鍵複製，直接貼到 ChatGPT 對話框即可。</div>
    <div style="display:flex; gap:10px; margin-bottom:8px; flex-wrap:wrap">
      <button id="genCopy" class="btn">產生文字</button>
      <button id="copyBtn" class="btn">複製</button>
    </div>
    <textarea id="copyBox" readonly style="width:100%; min-height:120px; border:1px solid #e5e7eb; border-radius:10px; padding:10px;"></textarea>
    <div class="muted" style="margin-top:6px">預設問題：「我今天運勢如何？」；若上方已有問題，會自動帶入。</div>
  </div></div>
</div>

<script>
// ===== 基本牌庫與佈局 =====
const IMG_DIR="./"; const BACK_FILE="CardBacks.jpg";
const MAJORS=[["00-TheFool.jpg","愚者","The Fool"],["01-TheMagician.jpg","魔術師","The Magician"],["02-TheHighPriestess.jpg","女祭司","The High Priestess"],["03-TheEmpress.jpg","皇后","The Empress"],["04-TheEmperor.jpg","皇帝","The Emperor"],["05-TheHierophant.jpg","教皇","The Hierophant"],["06-TheLovers.jpg","戀人","The Lovers"],["07-TheChariot.jpg","戰車","The Chariot"],["08-Strength.jpg","力量","Strength"],["09-TheHermit.jpg","隱者","The Hermit"],["10-WheelOfFortune.jpg","命運之輪","Wheel of Fortune"],["11-Justice.jpg","正義","Justice"],["12-TheHangedMan.jpg","吊人","The Hanged Man"],["13-Death.jpg","死神","Death"],["14-Temperance.jpg","節制","Temperance"],["15-TheDevil.jpg","惡魔","The Devil"],["16-TheTower.jpg","高塔","The Tower"],["17-TheStar.jpg","星星","The Star"],["18-TheMoon.jpg","月亮","The Moon"],["19-TheSun.jpg","太陽","The Sun"],["20-Judgement.jpg","審判","Judgement"],["21-TheWorld.jpg","世界","The World"]];
const NUM2ZH={1:"一",2:"二",3:"三",4:"四",5:"五",6:"六",7:"七",8:"八",9:"九",10:"十"};
const SUITS=[{prefix:"Wands",zhSuit:"權杖"},{prefix:"Cups",zhSuit:"聖杯"},{prefix:"Swords",zhSuit:"寶劍"},{prefix:"Pentacles",zhSuit:"錢幣"}];
function mkMinor(prefix,zhSuit){const out=[];for(let i=1;i<=14;i++){const nn=String(i).padStart(2,"0");let zhNum;i<=10?zhNum=NUM2ZH[i]:zhNum=i===11?"侍從":i===12?"騎士":i===13?"皇后":"國王";out.push([`${prefix}${nn}.jpg`,`${zhSuit}之${zhNum}`,`${prefix} ${nn}`]);}return out;}
const MINORS=SUITS.flatMap(s=>mkMinor(s.prefix,s.zhSuit));
const FULL_DECK=[...MAJORS,...MINORS].map(([file,zh,en])=>({file,zh,en,path:IMG_DIR+file}));

const picked=[]; let deckOrder=shuffle(FULL_DECK.slice());
const row1=document.getElementById('row1'), row2=document.getElementById('row2'), slots=document.getElementById('slots'), outEl=document.getElementById('out');

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function layoutRow(rowEl,cards){const w=rowEl.clientWidth,cw=74,step=(w-cw)/(cards.length-1);rowEl.innerHTML='';
  cards.forEach((card,i)=>{const x=Math.max(0,Math.min(w-cw,step*i));const back=document.createElement('div');back.className='cardback';back.style.left=x+'px';back.title=card.en;back.innerHTML=`<img src="${IMG_DIR+BACK_FILE}" alt="back" onerror="this.style.display='none'; this.parentElement.style.background='#0b4aa0';">`;back.onclick=()=>pickCard(card,back);rowEl.appendChild(back);});
}
function renderDeck(){const half=Math.ceil(deckOrder.length/2);layoutRow(row1,deckOrder.slice(0,half));layoutRow(row2,deckOrder.slice(half));}
function renderSlots(){slots.innerHTML='';for(let i=0;i<4;i++){const e=document.createElement('div');e.className='slot';e.dataset.idx=i;e.textContent=i===3?'建議':`牌 ${i+1}`;slots.appendChild(e);}picked.forEach((c,i)=>{const el=document.createElement('div');el.className='picked';el.innerHTML=`<img src="${c.path}"><div class="label">${c.reversed?'逆位':'正位'}｜${c.zh} <span class="muted" style="font-size:11px">(${c.en.replace('.jpg','')})</span></div>${i===3?'<div class="badge">建議</div>':''}`;el.onclick=()=>removePicked(c.file);slots.children[i].replaceWith(el);});}
function pickCard(card, backNode){if(picked.length>=4){alert("已選 4 張；請先清空或替換。");return;}if(picked.find(c=>c.file===card.file))return;picked.push({...card,reversed:Math.random()<0.48});backNode.classList.add('is-picked');backNode.style.pointerEvents='none';renderSlots();}
function removePicked(file){const idx=picked.findIndex(x=>x.file===file);if(idx>=0)picked.splice(idx,1);renderDeck();renderSlots();}

document.getElementById('shuffle').onclick=()=>{picked.splice(0,picked.length);deckOrder=shuffle(FULL_DECK.slice());renderDeck();renderSlots();outEl.textContent='（已洗牌，請重新選擇）';outEl.classList.add('muted');};
document.getElementById('clear').onclick=()=>{picked.splice(0,picked.length);renderDeck();renderSlots();outEl.textContent='（已清空選牌）';outEl.classList.add('muted');};

// ===== 本地牌義（使用你之前提供的 78 張正逆位簡表：因篇幅略） =====
const MEANINGS = { "Wands 08":{up:"迅速進展",rev:"延誤延遲"} }; // 省略：你已有完整版；本地檔請替換成你的 full 版本
function meaningFor(c){
  const en=c.en.replace('.jpg','');
  return MEANINGS[en] || {up:'一般含義',rev:'反面訊號'};
}
document.getElementById('btnLocal').onclick=()=>{
  const q=document.getElementById('q').value.trim();
  if(picked.length===0){alert('請先選牌');return;}
  const lines=picked.map((c,i)=>{const m=meaningFor(c);const pos=c.reversed?'逆位':'正位';const gist=c.reversed?m.rev:m.up;return `第${i+1}張${i===3?'（建議）':''}｜${c.zh}（${pos}）：${gist}`;}).join('\n');
  outEl.textContent=`你的問題：${q||'（未填）'}\n\n${lines}\n\n整體：先做最小可行步驟，觀察回饋再微調。`; outEl.classList.remove('muted');
};

// ===== 快速複製到 ChatGPT =====
function zhShortName(zh){ return zh.replace(/之/g,''); }
function buildCopySentence(){
  const q=(document.getElementById('q')?.value||'').trim()||'我今天運勢如何';
  if(!picked.length) return `你是一個有深度見解、溫暖且能快速找到重點的塔羅牌解牌師，請你根據我的問題：${q}，並且就根據這三張牌+一張建議牌給我解牌和建議。（尚未選牌）`;
  const names=picked.map(c=>`${zhShortName(c.zh)}${c.reversed?'逆位':'正位'}`);
  const first3=names.slice(0,3).join('、'); const advice=names[3]?`、${names[3]}`:'';
  return `你是一個有深度見解、溫暖且能快速找到重點的塔羅牌解牌師，請你根據我的問題：${q}，並且就根據這三張牌+一張建議牌給我解牌和建議。${first3}${advice}。`;
}
(function(){
  const box=document.getElementById('copyBox');
  function generate(){ box.value=buildCopySentence(); }
  function copy(){ if(!box.value) generate(); navigator.clipboard?.writeText(box.value).then(()=>alert('已複製到剪貼簿')); }
  document.getElementById('genCopy')?.addEventListener('click',generate);
  document.getElementById('copyBtn')?.addEventListener('click',copy);
  // 自動刷新
  const _pick=window.pickCard; window.pickCard=function(card,node){ _pick(card,node); if(box) box.value=buildCopySentence(); };
  const cb=document.getElementById('clear'); const sb=document.getElementById('shuffle');
  const oldc=cb.onclick; cb.onclick=function(){ oldc(); if(box) box.value=buildCopySentence(); };
  const olds=sb.onclick; sb.onclick=function(){ olds(); if(box) box.value=buildCopySentence(); };
  // 初次
  if(box) box.value=buildCopySentence();
})();

renderDeck(); renderSlots(); window.addEventListener('resize',()=>renderDeck());
</script>
</body>
</html>
